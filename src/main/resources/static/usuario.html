<!DOCTYPE html>
<html>

<head>
    <title>Usuarios</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
</head>

<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">COVID TRACKER</a>
            <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small">
                <li><a href="#" class="nav-link text-secondary">Início</a></li>
                <li><a href="#" class="nav-link text-white">Histórico</a></li>
                <li><a href="#" class="nav-link text-white">Opções</a></li>
            </ul>
        </div>
        </div>
    </nav>
</header>

<body>
    <div class="col-md-4 mx-auto">
        <h1 class="pt-5 pb-5">Gerenciamento de Usuários</h1>
        <form>
<!--            <tr> <td>ID:</td> <td><input type="text" id="_txtId"></td> </tr>-->
<!--            <tr> <td>Nome:</td> <td><input type="text" id="_txtNome"></td> </tr>-->
<!--            <tr> <td>Setor:</td> <td><input type="text" id="_txtSetor"></td> </tr>-->
<!--            <tr> <td>Tipo:</td> <td><input type="text" id="_txtTipo"></td> </tr>-->
<!--            <tr> <td>Senha:</td> <td><input type="text" id="_txtSenha"></td> </tr>-->
<!--            <tr> <td>Data de Nascimento:</td> <td><input type="text" id="_txtDataNasc"></td> </tr>-->
<!--            <tr> <td>Cidade:</td> <td><input type="text" id="_txtCidade"></td> </tr>-->
<!--            <tr> <td>Estado:</td> <td><input type="text" id="_txtEstado"></td> </tr>-->

            <div class="form-row">
                <div class="form-group col-md-2">
                    <label for="__txtId">ID</label>
                    <input type="number" class="form-control" id="__txtId">
                </div>
                <div class="form-group col-md-6">
                    <label for="__txtNome">Nome</label>
                    <input type="name" class="form-control" id="__txtNome">
                </div>
                <div class="form-group col-md-4">
                    <label for="__txtSenha">Senha</label>
                    <input type="password" class="form-control" id="__txtSenha">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="__txtId">Setor</label>
                    <input type="nome" class="form-control" id="__txtSetor">
                </div>
                <div class="form-group col-md-6">
                    <label for="__txtTipo">Tipo</label>
                    <select type="password" class="form-control" id="__txtTipo">
                        <option></option>
                        <option>Admin</option>
                        <option>Membro</option>
                        <option>Professor</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="__txtDataNasc">Data de Nascimento</label>
                    <input type="date" class="form-control" id="__txtDataNasc">
                </div>
                <div class="form-group col-md-4">
                    <label for="__txtDataNasc">Estado</label>
                    <input type="name" class="form-control" id="__txtDataEstado">
                </div>
                <div class="form-group col-md-4">
                    <label for="__txtDataNasc">Cidade</label>
                    <input type="name" class="form-control" id="__txtDataCidade">
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Salvar</button>
        </form>

<!--        <table>-->

<!--            <tr> <td>ID:</td> <td><input type="text" id="_txtId"></td> </tr>-->
<!--            <tr> <td>Nome:</td> <td><input type="text" id="_txtNome"></td> </tr>-->
<!--            <tr> <td>Setor:</td> <td><input type="text" id="_txtSetor"></td> </tr>-->
<!--            <tr> <td>Tipo:</td> <td><input type="text" id="_txtTipo"></td> </tr>-->
<!--            <tr> <td>Senha:</td> <td><input type="text" id="_txtSenha"></td> </tr>-->
<!--            <tr> <td>Data de Nascimento:</td> <td><input type="text" id="_txtDataNasc"></td> </tr>-->
<!--            <tr> <td>Cidade:</td> <td><input type="text" id="_txtCidade"></td> </tr>-->
<!--            <tr> <td>Estado:</td> <td><input type="text" id="_txtEstado"></td> </tr>-->
<!--            <tr><td></td><td>-->
<!--                <input type="button" value="Novo" onclick="novoAssociado()" id="_btnNovo">-->
<!--                <input type="button" value="Salvar" onclick="salvarAssociado()" id="_btnSalvar">-->
<!--                <input type="button" value="Apagar" onclick="apagarAssociado()" id="_btnApagar">-->
<!--                <input type="button" value="Cancelar" onclick="cancelarEdicao()" id="_btnCancelar">-->
<!--            </td></tr>-->
<!--        </table>-->

<!--        <table>-->
<!--            <tr> <td>ID:</td> <td><input type="text" id="txtId"></td> </tr>-->
<!--            <tr> <td>Nome:</td> <td><input type="text" id="txtNome"></td> </tr>-->
<!--            <tr> <td>CPF:</td> <td><input type="text" id="txtCpf"></td> </tr>-->
<!--            <tr><td></td><td>-->
<!--                <input type="button" value="Novo" onclick="novoAssociado()" id="btnNovo">-->
<!--                <input type="button" value="Salvar" onclick="salvarAssociado()" id="btnSalvar">-->
<!--                <input type="button" value="Apagar" onclick="apagarAssociado()" id="btnApagar">-->
<!--                <input type="button" value="Cancelar" onclick="cancelarEdicao()" id="btnCancelar">-->
<!--            </td></tr>-->
<!--        </table>-->

<!--        <p style="font-weight:bold" id="paragrafoMensagem"></p>-->

<!--        <table>-->
<!--        <tr> <th>ID</th> <th>Nome</th> <th>CPF</th></tr>-->
<!--        <tbody id="corpoTabelaAssociado"> </tbody>-->
<!--        </table>-->
</div>


    <script>
        const corpoTabela = document.querySelector('#corpoTabelaAssociado');
        const paragrafoMensagem = document.querySelector('#paragrafoMensagem');

        const txtId = document.querySelector('#txtId');
        const txtNome = document.querySelector('#txtNome');
        const txtCpf = document.querySelector('#txtCpf');

        const btnNovo = document.querySelector('#btnNovo');
        const btnSalvar = document.querySelector('#btnSalvar');
        const btnApagar = document.querySelector('#btnApagar');
        const btnCancelar = document.querySelector('#btnCancelar');

        var criandoNovoAssociado = false;

        inicializar();

        function inicializar() {
            criandoNovoAssociado = false;
            paragrafoMensagem.innerHTML = 'Pressione o botão Novo ou selecione um associado da lista:'

            txtId.value = '';
            txtNome.value = '';
            txtCpf.value = '';

            txtId.disabled = true;
            txtNome.disabled = true;
            txtCpf.disabled = true;

            btnNovo.disabled = false;
            btnSalvar.disabled = true;
            btnApagar.disabled = true;
            btnCancelar.disabled = true;

            listarTodosAssociados();
        }

        async function listarTodosAssociados() {
            const URL = `/api/associados`;
            fetch(URL)
              .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta;})
              .then(resposta => resposta.json())
              .then(jsonResponse => preencherTabela(jsonResponse))
              .catch(function(error) { paragrafoMensagem.innerHTML = "Erro ao listar associados (código " + error.message + ")";});
        }

        function preencherTabela( associados ) {
            var linhasTabela = '';
            var n = associados.length;
            for (var i = 0; i < n; i++) {
                var asso = associados[i];
                linhasTabela +=
                    `<tr><td><a href="javascript:void(0)" onclick="selecionarAssociado('${asso.cod_ass}','${asso.nome}','${asso.cpf}')">`
                    + asso.cod_ass     + '</a></td>' +
                    '<td>' + asso.nome   + '</td>' +
                    '<td>' + asso.cpf   + '</td></tr>\n';
            }
            corpoTabela.innerHTML = linhasTabela;
        }

        function selecionarAssociado(id, nome, cpf) {
            criandoNovoAssociado = false;

            paragrafoMensagem.innerHTML = 'Altere e salve os dados do associado, ou então apague o registro do associado.'
            txtId.value = id;
            txtNome.value = nome;
            txtCpf.value = cpf;

            txtId.disabled = true;
            txtNome.disabled = false;
            txtCpf.disabled = false;

            btnNovo.disabled = true;
            btnSalvar.disabled = false;
            btnApagar.disabled = false;
            btnCancelar.disabled = false;
        }

        function novoAssociado() {
            paragrafoMensagem.innerHTML = 'Preencha os dados do novo associado...';
            criandoNovoAssociado = true;

            txtId.value = '';
            txtNome.value = '';
            txtCpf.value = '';

            txtId.disabled = true;
            txtNome.disabled = false;
            txtCpf.disabled = false;

            btnNovo.disabled = true;
            btnSalvar.disabled = false;
            btnApagar.disabled = true;
            btnCancelar.disabled = false;
        }

        function salvarAssociado() {
            if (criandoNovoAssociado) {
                criarAssociado();
            }
            else {
                alterarAssociado();
            }
        }

        async function criarAssociado() {
            const URL = `/api/associados`;
            const dadosAssociado = {
                'nome': txtNome.value,
                'cpf': txtCpf.value
            };
            const postRequest = {
                method: 'POST',
                body: JSON.stringify(dadosAssociado),
                headers: { 'Content-type': 'application/json' }
            };
            fetch(URL, postRequest)
                .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
                .then(resposta => resposta.json())
                .then(jsonResponse => inicializar())
                .catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao criar novo associado (código ' + error.message + ')'; } );
        }

        async function alterarAssociado() {
            const ID = txtId.value;
            const URL = `/api/associados/${ID}`;
            const dadosAssociado = {
                'cod_ass': ID,
                'nome': txtNome.value,
                'cpf': txtCpf.value
            };
            const putRequest = {
                method: 'PUT',
                body: JSON.stringify(dadosAssociado),
                headers: { 'Content-type': 'application/json' }
            };
            fetch(URL, putRequest)
                .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
                .then(resposta => resposta.json())
                .then(jsonResponse => inicializar())
                .catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao alterar associado (código ' + error.message + ')'; } );
        }

        function cancelarEdicao() {
            inicializar();
        }

        async function apagarAssociado() {
            const ID = txtId.value;
            const URL = `/api/associados/${ID}`;
            const deleteRequest = {
                method: 'DELETE'
            };
            fetch(URL, deleteRequest)
                .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
                .then(resposta => inicializar())
                .catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao apagar associado (código ' + error.message + ')'; } );
        }

    </script>
</body>

</html>

    